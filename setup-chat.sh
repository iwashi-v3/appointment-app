#!/bin/bash

echo "ğŸš€ ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ"

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒãƒ£ãƒƒãƒˆç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
echo "ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆä¸­..."
if [ -f "database/init-chat.sql" ]; then
    # Dockerã‚³ãƒ³ãƒ†ãƒŠã®PostgreSQLã«æ¥ç¶šã—ã¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
    docker exec -i $(docker ps -q --filter "ancestor=postgres") psql -U postgres -d postgres < database/init-chat.sql
    echo "âœ… ãƒãƒ£ãƒƒãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ"
else
    echo "âŒ init-chat.sqlãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    exit 1
fi

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
echo "ğŸ“¦ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
cd backend
npm install
echo "âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã‚’ç”Ÿæˆ
echo "ğŸ”§ Drizzleã‚¹ã‚­ãƒ¼ãƒã‚’ç”Ÿæˆä¸­..."
npm run db:generate
npm run db:push
echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®ç”Ÿæˆå®Œäº†"

# ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
npm run test -- --testPathPattern=chat.service.spec.ts
if [ $? -eq 0 ]; then
    echo "âœ… ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
else
    echo "âš ï¸  ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸï¼ˆé–‹ç™ºç’°å¢ƒã§ã¯æ­£å¸¸ã§ã™ï¼‰"
fi

cd ..

echo ""
echo "ğŸ‰ ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
echo ""
echo "ğŸ“‹ æ¬¡ã®æ‰‹é †ï¼š"
echo "1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’èµ·å‹•: cd backend && npm run start:dev"
echo "2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã« socket.io-client ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
echo "3. CHAT_API_DOCS.md ã‚’å‚ç…§ã—ã¦ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…"
echo ""
echo "ğŸ”— WebSocketæ¥ç¶šURL: ws://localhost:3000/chat"
echo "ğŸ“š APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: CHAT_API_DOCS.md"
